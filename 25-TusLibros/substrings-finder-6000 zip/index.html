<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Substrings Finder</title>

  <!-- Fonts to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <!-- Icons to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>

<body>
  <div id="root"></div>

  <script src="./lib/react.development.js" crossorigin="anonymous"></script>
  <script src="./lib/react-dom.development.js" crossorigin="anonymous"></script>
  <script src="./lib/material-ui.development.js" crossorigin="anonymous"></script>
  <script src="./lib/babel.min.js" crossorigin="anonymous"></script>
  <script src="./src/refreshbrowser.js" crossorigin="anonymous"></script>

  <!-- Libraries fallback -->
  <script>window.React || document.write('<script src="https://unpkg.com/react@16.11.0/umd/react.development.js">\x3C/script>')</script>
  <script>window.ReactDOM || document.write('<script src="https://unpkg.com/react-dom@16.11.0/umd/react-dom.development.js">\x3C/script>')</script>
  <script>window.MaterialUI || document.write('<script src="https://unpkg.com/@material-ui/core@4.6.1/umd/material-ui.development.js">\x3C/script>')</script>
  <script>window.Babel || document.write('<script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js">\x3C/script>')</script>
  <!-- end fallback -->

  <script type="text/babel" type="module">
    const {
      // theme, styles
      colors,
      createMuiTheme,
      makeStyles,
      withStyles,
      // components
      AppBar,
      Button,
      Container,
      CssBaseline,
      Icon,
      IconButton,
      InputAdornment,
      InputLabel,
      FormControl,
      Link,
      List,
      ListItem,
      ListItemIcon,
      ListItemText,
      OutlinedInput,
      TextField,
      ThemeProvider,
      Toolbar,
      Typography,
      ListItemSecondaryAction,
      Table,
      TableHead,
      TableBody,
      TableRow,
      TableCell,
      TableFooter
    } = MaterialUI;
    const theme = createMuiTheme({
      palette: {
        primary: {
          main: '#556cd6',
        },
        secondary: {
          main: '#19857b',
        },
        error: {
          main: colors.red.A400,
        },
        background: {
          default: '#fff',
          paper: '#f5f5f5',
        },
      },
    });
    
    const styles = theme => ({
      root: {
        margin: theme.spacing(6, 0, 3),
      },
      lightBulb: {
        verticalAlign: 'middle',
        // marginRight: theme.spacing(1),
      },
      rootToolBar: {
        flexGrow: 1,
      },
      menuButton: {
        marginRight: theme.spacing(2),
      },
      textField: {
        marginTop: theme.spacing(2),
        marginBottom: theme.spacing(2),
      },
      title: {
        flexGrow: 1,
      },
      rootList: {
        width: '100%',
        backgroundColor: theme.palette.background.paper,
        position: 'relative',
        overflow: 'auto',
        maxHeight: 300,
      },
      textFieldDetails: {
        margin: theme.spacing(2),
      },
      catalogListItem: {
        display: 'flex'
      },
      // catalogListItemQty: {
      //   flex: 0 0 auto;
      //   color: rgba(0, 0, 0, 0.54);
      //   padding: 12px;
      //   overflow: visible;
      //   font-size: 1.5rem;
      //   text-align: center;
      //   transition: background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
      //   border-radius: 50%;
      // }
    })
    
    const useStyles = makeStyles(styles);

    const getLocalAsJson = (path) => {
      const port = 9010
    
      return fetch(`http://localhost:${port}/${path}`, {
        method: "GET",
        dataType: "JSON",
        headers: {
          "Access-Control-Request-Headers": "*"
        }
      })
    }

    class MyToolBarComponent extends React.Component {
      constructor(props) {
        super(props)
      }
    
    
      logout = () => {
        this.props.router.navigate("/", {
          cartId: 0,
        })
      }
    
      goToCart = () => {
        this.props.router.navigate("/cart", {
        })
      }
    
      goToCatalog = () => { 
        this.props.router.navigate("/catalog", {
          cartId: this.props.cartId,
        })
      }
    
    
      goToHistory = () => this.props.router.navigate("/history", {
      })
    
      render() {
        const {
          router,
          title,
          classes,
          cartId,
        } = this.props
    
        const current_path = router.current()
    
        return (
          <div className={classes.rootToolBar}>
            <AppBar position="static">
              <Toolbar>
                {!!cartId && current_path != '/catalog' &&
                  <IconButton
                    edge="start"
                    className={classes.menuButton}
                    color="inherit"
                    onClick={this.goToCatalog}
                  >
                    <Icon>{'menu_book'}</Icon>
                  </IconButton>
                }
                {!!cartId && current_path != '/cart' &&
                  <IconButton
                    edge="start"
                    className={classes.menuButton}
                    color="inherit"
                    onClick={this.goToCart}
                  >
                    <Icon>{'shopping_cart'}</Icon>
                  </IconButton>
                }
                {current_path != '/' && current_path != '/history' &&
                  <IconButton
                    edge="start"
                    className={classes.menuButton}
                    color="inherit"
                    onClick={this.goToHistory}
                  >
                    <Icon>{'history'}</Icon>
                  </IconButton>
                }
                <Typography variant="h6" className={classes.title}>
                  {title}
                </Typography>
                {current_path != '/' &&
                  <IconButton
                    edge="end"
                    className={classes.menuButton}
                    color="inherit"
                    onClick={this.logout}
                  >
                    <Icon>{'logout'}</Icon>
                  </IconButton>
                }
              </Toolbar>
            </AppBar>
          </div>
        )
      }
    
    }
    
    // Add style
    const MyToolBar = withStyles(styles, {
      withTheme: true
    })(MyToolBarComponent)
    class StringInputComponent extends React.Component {
      constructor(props) {
        super(props)
    
        this.state = {
          clientId: '',
          password: ''
        }
      }
    
      handleUserChange(event) {
        this.setState({
          clientId: event.target.value
        })
      };
    
      handlePasswordChange(event) {
        this.setState({
          password: event.target.value
        })
      };
    
      handleSend() {
        const {
          router,
        } = this.props
    
        const {
          clientId,
          password
        } = this.state
    
        getLocalAsJson(`createCart?clientId=${clientId}&password=${password}`)
          .then(function (response) {
            return response.json()
          })
          .then(function (json) {
            router.navigate("/catalog", { cartId: json, user: clientId })
          })
          .catch(function (error) {
            console.log('Looks like there was a problem: \n', error);
          });
      }
    
      render() {
        const {
          clientId,
          password
        } = this.state
    
        const {
          classes,
        } = this.props
    
        return (
          <div>
            <Typography component="h1" gutterBottom>
              Ingrese un usuario y contrase√±a
              </Typography>
            <FormControl fullWidth className={classes.textField}>
              <TextField
                id="outlined-adornment-amount"
                value={clientId}
                onChange={(ev)=>this.handleUserChange(ev)}
                placeholder={'User Id'}
              />
              <TextField
                id="outlined-adornment-amount"
                value={password}
                onChange={(ev)=>this.handlePasswordChange(ev)}
                type='password'
                placeholder={'Password'}
              />
            </FormControl>
    
            <Button
              color="inherit"
              onClick={(ev)=>this.handleSend(ev)}>
              Create Cart
          </Button>
          </div>
        )
      }
    }
    
    // Add style
    const StringInputView = withStyles(styles, {
      withTheme: true
    })(StringInputComponent)
    const catalog = [
      {
          title: '1',
          isbn: 'validBook',
          quantity: 0,
          author: 'author1',
      },
      {
          title: '2',
          isbn: 'isbn2',
          quantity: 0,
          author: 'author2',
      },
      {
          title: '3',
          isbn: 'isbn3',
          quantity: 0,
          author: 'author3',
      },
      {
          title: '4',
          isbn: 'isbn4',
          quantity: 0,
          author: 'author4',
      },
      {
          title: '5',
          isbn: 'isbn5',
          quantity: 0,
          author: 'author5',
      },
      {
          title: '6',
          isbn: 'isbn6',
          quantity: 0,
          author: 'author6',
      },
      {
          title: '7',
          isbn: 'isbn7',
          quantity: 0,
          author: 'author7',
      },
      {
          title: '8',
          isbn: 'isbn8',
          quantity: 0,
          author: 'author8',
      },
      {
          title: '9',
          isbn: 'isbn9',
          quantity: 0,
          author: 'author9',
      },
    ]
    
    
    class SubstringsComponent extends React.Component {
      constructor(props) {
        super(props)
        this.state = {
          catalog: catalog,
          cartItems: [],
          refresh: false
        }
      }
    
      componentDidMount() {
        this.listCart()
        
      }
    
      listCart = () => {
        this.setState({
          loading: true,
          error: null,
          refresh: false
        })
        let cartItems = []
    
        getLocalAsJson(`listCart?cartId=${this.props.cartId}`)
          .then(function (response) {
            return response.json()
          })
          .then(function (json) {
            cartItems = json
          })
          .then((details) => {
            this.setState({
              loading: false,
              cartItems: cartItems
            })
          })
          .catch(err => {
            this.setState({
              loading: false,
              error: err,
            })
          })
      }
    
      getItemQty = (isbn) => {
        const total = this.state.cartItems.reduce((accum, curr) => {
          if(curr == isbn) {
            return accum + 1
          }
          return accum
        }, 0)
        return total
      }
    
      checkout = () => {
        let ticket = []
        getLocalAsJson(`checkOutCart?cartId=${this.props.cartId}`)
          .then(function (response) {
            return response.json()
          })
          .then(function (json) {
            ticket = json
          })
          .then((details) => {
            this.props.router.navigate("/checkout", {ticket, cartId: 0})
          })
          .catch(err => {
            this.setState({
              loading: false,
              error: err,
            })
          })
      }
    
      render() {
        if (this.state.loading) return <div>Loading...</div>
        const {
          router,
          cartId,
          classes,
          cartView
        } = this.props
        return (
          <div>
            <Typography component="h1" gutterBottom>
              {cartView ? 'Carrito:' :  'Catalogo:'}
              </Typography>
            <List component="nav" className={classes.rootList} >
              {
                this.state.catalog.map((item) => {
                  return (
                    <CatalogItem
                      item={item}
                      key={item.isbn}
                      classes={classes}
                      getItemQty={this.getItemQty}
                      router={router}
                      cartId={this.props.cartId}
                      cartView={cartView}
                    />
                  )
                })
              }
            </List>
            { cartView &&
              <Button onClick={this.checkout}>
                Checkout
              </Button>
            }
          </div>
        )
      }
    }
    
    
    
    class CatalogItem extends React.Component {
      constructor(props) {
        super(props)
        this.state = {
          quantity: props.getItemQty(props.item.isbn)
        }
    
      }
    
      add = () => {
        getLocalAsJson(`addToCart?cartId=${this.props.cartId}&bookIsbn=${this.props.item.isbn}&bookQuantity=1`)
          .then(() => {
            this.setState({
              quantity: this.state.quantity + 1,
            })
          })
          .catch(err => {
            this.setState({
              error: err,
            })
          })
    
      }
    
      remove = () => {
        getLocalAsJson(`removeFromCart?cartId=${this.props.cartId}&bookIsbn=${this.props.item.isbn}`)
          .then(() => {
            this.setState({
              quantity: this.state.quantity - 1,
            })
          })
          .catch(err => {
            this.setState({
              error: err,
            })
          })
    
      }
    
      details = () => {
        this.props.router.navigate("/details", { item: this.props.item, quantity: this.state.quantity })
      }
    
      render() {
        const {
          router,
          item,
          classes,
          cartView
        } = this.props
        if (cartView && this.state.quantity == 0) return null
        return (
          <ListItem
            key={item.isbn}
            button
            onClick={this.details}
          >
            <ListItemText primary={item.title} secondary={item.isbn} />
              <ListItemSecondaryAction
                className={classes.catalogListItem}             
              >
                <IconButton
                  onClick={this.remove}
                >
                  -
                </IconButton>
                <IconButton disabled>{this.state.quantity}</IconButton>
                <IconButton
                  onClick={this.add}
                >
                  +
                </IconButton>
              </ListItemSecondaryAction>
          </ListItem>      
        )
      }
    }
    
    // Add style
    const SubstringsView = withStyles(styles, {
      withTheme: true
    })(SubstringsComponent)
    class SubstringDetailsComponent extends React.Component {
      constructor(props) {
        super(props)
    
        this.state = {
          quantity: props.quantity
        }
      }
    
    
      add = () => {
        getLocalAsJson(`addToCart?cartId=${this.props.cartId}&bookIsbn=${this.props.item.isbn}&bookQuantity=1`)
          .then(() => {
            this.setState({
              quantity: this.state.quantity + 1,
            })
          })
          .catch(err => {
            this.setState({
              error: err,
            })
          })
    
      }
    
      remove = () => {
        getLocalAsJson(`removeFromCart?cartId=${this.props.cartId}&bookIsbn=${this.props.item.isbn}`)
          .then(() => {
            this.setState({
              quantity: this.state.quantity - 1,
            })
          })
          .catch(err => {
            this.setState({
              error: err,
            })
          })
    
      }
    
      render() {
        const {
          // router,
          classes,
          item
        } = this.props
    
        const {
          details,
          loading,
          error,
        } = this.state
    
        if (loading) return <div>Loading...</div>
        if (error) return <div>{error}</div>
        return (
          <div>
            <Typography variant="h4" component="h4" gutterBottom>
              Detalles de <b>{item.title}</b>
            </Typography>
    
            <TextField
              id="outlined-read-only-input"
              label="Autor"
              defaultValue={item.author}
              className={classes.textFieldDetails}
              margin="normal"
              InputProps={{
                readOnly: true,
              }}
              variant="outlined"
            />
            <TextField
              id="outlined-read-only-input"
              label="ISBN"
              defaultValue={item.isbn}
              className={classes.textFieldDetails}
              margin="normal"
              InputProps={{
                readOnly: true,
              }}
              variant="outlined"
            />
            <IconButton
              onClick={this.remove}
            >
              -
            </IconButton>
            <IconButton disabled>{this.state.quantity}</IconButton>
            <IconButton
              onClick={this.add}
            >
              +
            </IconButton>
          </div>
        )
      }
    }
    
    // Add style
    const SubstringDetailsView = withStyles(styles, {
      withTheme: true
    })(SubstringDetailsComponent)
    class CheckoutComponent extends React.Component {
        constructor(props) {
          super(props)
      
          this.state = {
            
          }
        }
    
        calcTotal = () => {
            const total = this.props.ticket.reduce((accum, curr) => {
                  return accum + curr[2]
              }, 0)
            return total
        }
    
        render() {
          const {
            // router,
            classes,
            ticket
          } = this.props
      
          const {
            loading,
            error,
          } = this.state
      
          if (loading) return <div>Loading...</div>
          if (error) return <div>{error}</div>
          return (
            <div>
              <Table className={classes.table} aria-label="simple table">
                <TableHead>
                    <TableRow>
                        <TableCell>Libro</TableCell>
                        <TableCell align="right">Cantidad</TableCell>
                        <TableCell align="right">Precio</TableCell>
                    </TableRow>
                </TableHead>
                <TableBody>
                {ticket.map(row => (
                    <TableRow key={row[0]}>
                    <TableCell component="th" scope="row">
                        {row[0]}
                    </TableCell>
                    <TableCell align="right">{row[1]}</TableCell>
                    <TableCell align="right">{row[2]}</TableCell>
                    </TableRow>
                ))}
                </TableBody>
                <TableFooter>
                    <TableRow key={'total'}>
                    <TableCell component="th" scope="row">
                        {'Total'}
                    </TableCell>
                    <TableCell align="left"></TableCell>
                    <TableCell align="right">{this.calcTotal()}</TableCell>
                    </TableRow>
                </TableFooter>
            </Table>
            </div>
          )
        }
      }
      
      // Add style
      const CheckoutView = withStyles(styles, {
        withTheme: true
      })(CheckoutComponent)
          class App extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          path: "/",
          substrings: [],
          selectedSubstring: "",
          cartId: 0
        };
      }
    
      render() {
        let title = "Tus Libros"
        let content = "Where am I?"
        const router = {
          current: () => this.state.path,
          navigate: (path, state) => {
            // http://es6-features.org/#SpreadOperator
            this.setState({ ...state, path: path })
          }
        }
    
        if (this.state.path === "/") {
          content = (<StringInputView
            router={router}
          />)
        } else if (this.state.path === "/catalog") {
            content = (<SubstringsView
            router={router}
            cartId={this.state.cartId}
          />)
        } else if (this.state.path === "/cart") {
            content = (<SubstringsView
            router={router}
            cartId={this.state.cartId}
            cartView
          />)
        } else if (this.state.path === "/details") {
          content = (<SubstringDetailsView
            router={router}
            item={this.state.item}
            quantity={this.state.quantity}
            cartId={this.state.cartId}
          />)
        } else if (this.state.path === '/checkout') {
          content = (
            <CheckoutView
              ticket={this.state.ticket}
            />
          )
        }
        return (
          <div>
            <MyToolBar
              title={title}
              router={router}
              cartId={this.state.cartId}
            />
            <Container maxWidth="sm">
              <div style={{ marginTop: 24, }}>
                {content}
              </div>
            </Container>
          </div>
        );
      }
    }

    ///////////////////////////////////////////////////////////////////////////
    // Initial render
    //
    ReactDOM.render(
      <ThemeProvider theme={theme}>
        <CssBaseline />
        <App />
      </ThemeProvider>,
      document.getElementById('root')
    )
  </script>

  <!-- <button onclick="window.location.reload(true)">reload</button> -->
</body>

</html>
